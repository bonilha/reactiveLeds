<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDs do Fábio - Samba Mode ON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); font-family: 'Segoe UI', sans-serif; }
        .spectrum-bar { transition: height 60ms ease-out, opacity 120ms; }
        .btn-br { @apply font-bold py-4 px-8 rounded-xl text-lg shadow-2xl transform transition-all duration-200 hover:scale-105 active:scale-95; }
        .beat-flash { animation: beat 0.2s ease-out; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header BR -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-black mb-2 bg-gradient-to-r from-green-400 via-yellow-400 to-green-600 bg-clip-text text-transparent">
                LEDs do Fábio
            </h1>
            <p class="text-xl text-yellow-300">Samba, Pagode, Funk, Sertanejo → Tudo reage na hora!</p>
        </div>

        <!-- Botões Mágicos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <button id="btn-music-playing" class="btn-br bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500">
                <span class="text-2xl block">Música Tocando!</span>
                <span class="text-sm opacity-90">Tá tocando samba mas os LEDs tão mortos? Clique aqui!</span>
            </button>

            <button id="btn-silence" class="btn-br bg-gradient-to-r from-gray-700 to-gray-900 hover:from-gray-600 hover:to-gray-800">
                <span class="text-2xl block">Silêncio Total</span>
                <span class="text-sm opacity-90">Música parou mesmo · Clique pra apagar com classe</span>
            </button>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-black/40 backdrop-blur rounded-2xl p-6 border border-green-500/30">
                <div class="text-green-400 text-sm">Conexão</div>
                <div id="conn-text" class="text-3xl font-bold mt-2">Conectando...</div>
            </div>
            <div class="bg-black/40 backdrop-blur rounded-2xl p-6 border border-yellow-500/30">
                <div class="text-yellow-400 text-sm">FPS</div>
                <div id="fps" class="text-3xl font-bold mt-2">0</div>
            </div>
            <div class="bg-black/40 backdrop-blur rounded-2xl p-6 border border-purple-500/30">
                <div class="text-purple-400 text-sm">Beat</div>
                <div id="beat-indicator" class="text-5xl font-black hidden">BEAT</div>
            </div>
            <div class="bg-black/40 backdrop-blur rounded-2xl p-6 border border-blue-500/30">
                <div class="text-blue-400 text-sm">Modo Atual</div>
                <div id="current-mode" class="text-2xl font-bold mt-2">Auto</div>
            </div>
        </div>

        <!-- Espectro AO VIVO -->
        <div class="bg-black/50 backdrop-blur-xl rounded-3xl p-8 border border-white/10">
            <h2 class="text-3xl font-bold mb-6 text-center">Espectro em Tempo Real</h2>
            <div id="spectrum" class="h-80 flex gap-1 items-end justify-center bg-black/40 rounded-2xl p-4"></div>
        </div>

        <div class="text-center mt-8 text-gray-400 text-sm">
            Feito com amor no Brasil por @Fabio_Bonilha · 11 de Novembro de 2025
        </div>
    </div>

    <script>
        const ws = new WebSocket('ws://' + location.hostname + ':8765');
        let currentMode = "auto";

        // Cria 120 barras (melhor resolução)
        const spectrum = document.getElementById('spectrum');
        const bars = [];
        for (let i = 0; i < 120; i++) {
            const bar = document.createElement('div');
            bar.className = 'spectrum-bar w-2 bg-gradient-to-t from-green-500 via-yellow-400 to-green-600 rounded-t-full opacity-30';
            bar.style.height = '0%';
            spectrum.appendChild(bar);
            bars.push(bar);
        }

        // Botão 1: Música Tocando (força modo samba)
        document.getElementById('btn-music-playing').addEventListener('click', () => {
            fetch('http://localhost:8765/api/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mode: "samba_mode",
                    silence_bands: 48,
                    silence_rms: 0.028,
                    silence_duration: 5.0,
                    resume_factor: 1.8
                })
            });
            document.getElementById('current-mode').textContent = "SAMBA MODE";
            document.getElementById('current-mode').className = "text-2xl font-bold mt-2 text-green-400";
            alert("SAMBA MODE ATIVADO! Os LEDs vão sambar até o amanhecer!");
        });

        // Botão 2: Silêncio real
        document.getElementById('btn-silence').addEventListener('click', () => {
            fetch('http://localhost:8765/api/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: "true_silence" })
            });
            document.getElementById('current-mode').textContent = "SILÊNCIO";
            document.getElementById('current-mode').className = "text-2xl font-bold mt-2 text-red-500";
            alert("LEDs apagando com classe... Boa noite!");
        });

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            // Atualiza FPS
            document.getElementById('fps').textContent = data.fps ? data.fps.toFixed(1) : '0';

            // Beat flash
            if (data.beat) {
                const beatEl = document.getElementById('beat-indicator');
                beatEl.classList.remove('hidden');
                beatEl.classList.add('beat-flash');
                setTimeout(() => beatEl.classList.remove('beat-flash'), 200);
            }

            // Espectro
            if (data.bands && data.bands.length > 0) {
                const step = Math.max(1, Math.floor(data.bands.length / bars.length));
                bars.forEach((bar, i) => {
                    const val = data.bands[Math.min(i * step, data.bands.length - 1)];
                    const height = (val / 255) * 100;
                    bar.style.height = height + '%';
                    bar.style.opacity = val > 40 ? '1' : '0.4';
                });
            }

            // Status conexão
            document.getElementById('conn-text').textContent = data.connected ? "CONECTADO" : "SEM CONEXÃO";
            document.getElementById('conn-text').style.color = data.connected ? "#22c55e" : "#ef4444";
        };

        ws.onopen = () => console.log("WebSocket conectado");
        ws.onclose = () => setTimeout(() => location.reload(), 3000);
    </script>
</body>
</html>